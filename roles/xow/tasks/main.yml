---

- name: Install APT dependencies
  apt:
    name: "{{ item }}"
  loop:
    - libusb-1.0-0-dev
    - cabextract

- name: Clone from git
  become: no
  git:
    repo: 'https://github.com/medusalix/xow'
    dest: '/home/{{ user }}/Apps/xow'
    depth: 1

- name: Verify clone
  stat:
    path: '/home/{{ user }}/Apps/xow'
  register: xow_path

- name: Build xow
  become: no
  shell: 'make BUILD=RELEASE'
  args:
    chdir: '/home/{{ user }}/Apps/xow'
  when: xow_path.stat.exists

- name: Make firmware script executable
  become: no
  file:
    path: '/home/{{ user }}/Apps/xow/firmware.sh'
    mode: '0755'
  when: xow_path.stat.exists

- name: Download firmware
  become: yes
  expect:
    command: './firmware.sh'
    responses:
      '(.*)Do you accept the terms of the agreement(.*)':
        - 'y'
  args:
    chdir: '/home/{{ user }}/Apps/xow'
  when: xow_path.stat.exists

- name: Install xow
  shell: 'make install'
  become: yes
  args:
    chdir: '/home/{{ user }}/Apps/xow'
  when: xow_path.stat.exists
  ignore_errors: true

- name: Enable service
  become: yes
  systemd:
    name: xow
    enabled: yes
    state: started

