---

- name: Check if already installed
  stat:
    path: '~/.local/share/applications/firefoxDeveloperEdition.desktop'
  register: jbtb


- name: Download from Jetbrains
  get_url:
    url: 'https://data.services.jetbrains.com/products/download?platform=linux&code=TBA'
    dest: /tmp/jetbrains-toolbox.tar.gz
  register: tlbxdownload
  when: not jbtb.stat.exists

- name: Extract archive
  unarchive:
    src: /tmp/jetbrains-toolbox.tar.gz
    dest: /tmp/
  when: (not jbtb.stat.exists) and (tlbxdownload is changed)

- name: Get extracted dir
  find:
    paths: /tmp
    patterns: 'jetbrains-toolbox-*'
    file_type: directory
    depth: 1
  register: extractpath
  when: not jbtb.stat.exists

- name: Execute Jetbrains Toolbox (triggers install)
  shell: ./jetbrains-toolbox
  args:
    chdir: '{{ extractpath.files[0].path }}'

  when: not jbtb.stat.exists

- name: Leave install marker
  file:
    path: /opt/.jetbrains-toolbox-installed
    state: touch
    mode: u=rw,g=r,o=r
  when: not jbtb.stat.exists